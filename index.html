<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanMachi Members</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #0d1b2a;
            color: #e0e1dd;
        }
        .banner {
            display: block;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #1b263b;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        h1, h2 {
            color: #e0e1dd;
            text-align: center;
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #415a77;
        }
        th {
            background-color: #0d47a1;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #141f33;
        }
        tr:hover {
            background-color: #2c3e50;
        }
        .baseball {
            position: relative;
        }
        .baseball:after {
            content: "⚾";
            margin-left: 5px;
        }
        
        /* Tab styles */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #0d47a1;
        }
        
        .tab-button {
            background-color: #1b263b;
            border: none;
            color: #e0e1dd;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: all 0.3s ease;
            margin-right: 5px;
        }
        
        .tab-button:hover {
            background-color: #2c3e50;
        }
        
        .tab-button.active {
            background-color: #0d47a1;
            color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 27, 42, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background-color: #1b263b;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 500px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .login-container h2 {
            margin: 0;
            color: #e0e1dd;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 0;
            border: 1px solid #415a77;
            border-radius: 4px;
            background-color: #0d1b2a;
            color: #e0e1dd;
            font-size: 16px;
        }

        .login-button {
            background-color: #0d47a1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }

        .login-button:hover {
            background-color: #1565c0;
        }

        .error-message {
            color: #ff5252;
            margin: 0;
            display: none;
        }

        /* Scheduler styles */
        .scheduler-form {
            background-color: #1b263b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e0e1dd;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #415a77;
            border-radius: 4px;
            background-color: #0d1b2a;
            color: #e0e1dd;
        }
        
        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .player-card {
            background-color: #141f33;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #415a77;
        }
        
        .btn {
            background-color: #0d47a1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #1565c0;
        }
        
        .remove-player {
            color: #ff5252;
            cursor: pointer;
            float: right;
        }

        .main-content {
            display: none;
        }

        .admin-controls {
            display: none;
            margin: 20px 0;
            text-align: center;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .raid-tabs-container {
            margin-top: 30px;
        }
        
        .raid-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #0d47a1;
            padding-bottom: 5px;
        }
        
        .raid-tab {
            background-color: #1b263b;
            border: none;
            color: #e0e1dd;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .raid-tab:hover {
            background-color: #2c3e50;
        }
        
        .raid-tab.active {
            background-color: #0d47a1;
            color: white;
            font-weight: bold;
        }
        
        .raid-content {
            display: none;
            background-color: #1b263b;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .raid-content.active {
            display: block;
        }
        
        .raid-info {
            margin-bottom: 20px;
        }
        
        .raid-info p {
            margin: 5px 0;
            color: #e0e1dd;
        }
        
        .raid-info strong {
            color: #90caf9;
        }

        .forms-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .form-section {
            background-color: #1b263b;
            padding: 20px;
            border-radius: 8px;
        }
        
        .team-tabs-container {
            margin-top: 20px;
        }
        
        .team-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #0d47a1;
            padding-bottom: 5px;
        }
        
        .team-tab {
            background-color: #1b263b;
            border: none;
            color: #e0e1dd;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .team-tab:hover {
            background-color: #2c3e50;
        }
        
        .team-tab.active {
            background-color: #0d47a1;
            color: white;
            font-weight: bold;
        }
        
        .team-content {
            display: none;
            background-color: #1b263b;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .team-content.active {
            display: block;
        }
        
        .empty-slot {
            color: #ff5252;
            font-style: italic;
        }

        .swal2-input, .swal2-select {
            margin: 10px auto !important;
        }
        
        .swal2-label {
            color: #e0e1dd !important;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #415a77;
            border-radius: 4px;
            background-color: #0d1b2a;
            color: #e0e1dd;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        
        textarea.form-control {
            min-height: 100px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .btn-primary {
            background-color: #0d47a1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #1565c0;
        }
        
        .swal2-popup {
            background-color: #1b263b !important;
            color: #e0e1dd !important;
        }
        
        .swal2-title, .swal2-content {
            color: #e0e1dd !important;
        }
        
        .swal2-input, .swal2-select, .swal2-textarea {
            background-color: #0d1b2a !important;
            color: #e0e1dd !important;
            border-color: #415a77 !important;
        }
        
        .swal2-input:focus, .swal2-select:focus, .swal2-textarea:focus {
            border-color: #0d47a1 !important;
            box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2) !important;
        }
    </style>
    <script src="js/db.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <img class="banner" src="https://i.pinimg.com/originals/3a/5f/a6/3a5fa66a0eb93df05cfc9c248995eb54.gif" alt="DanMachi Banner">
            <h2>Enter Password</h2>
            <input type="password" id="passwordInput" class="login-input" placeholder="Enter password">
            <button onclick="checkPassword()" class="login-button">Login</button>
            <div id="errorMessage" class="error-message">Incorrect password</div>
        </div>
    </div>

    <div id="mainContent" class="main-content">
        <img class="banner" src="https://i.pinimg.com/originals/3a/5f/a6/3a5fa66a0eb93df05cfc9c248995eb54.gif" alt="DanMachi Banner">
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showScheduleForm()">Schedule a Raid</button>
            <button class="btn btn-primary" onclick="showRegistrationForm()">Register to Raid</button>
        </div>

        <div class="admin-controls" id="adminControls">
            <button class="delete-btn" onclick="showDeleteConfirmation()">Delete Raid</button>
        </div>

        <div class="container">
            <h1>Sea Dragon Team (SDN)</h1>
            
            <div class="tabs">
                <button class="tab-button active" onclick="openTab('scheduler')">Scheduled Raids</button>
            </div>
            
            <div id="scheduler" class="tab-content active">
                <h2>Scheduled Raids</h2>
                <div class="team-tabs-container">
                    <div class="team-tabs" id="teamTabs">
                        <!-- Dynamic team tabs will be added here -->
                    </div>
                    <div id="teamContents">
                        <!-- Dynamic team contents will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Add isAdmin variable
        let isAdmin = false;

        // Check for existing authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const isAuthenticated = await db.getAuth();
                if (isAuthenticated) {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking authentication:', error);
            }
        });

        // Modify checkPassword function
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const correctPassword = 'HestiaNo1Fans';
            const adminPassword = 'AdminMinohehe';
            
            if (password === correctPassword || password === adminPassword) {
                try {
                    await db.setAuth(true);
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none';
                    
                    // Show admin controls if admin password was used
                    if (password === adminPassword) {
                        isAdmin = true;
                        document.getElementById('adminControls').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error setting authentication:', error);
                }
            } else {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        // Handle Enter key in password input
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        function openTab(tabName) {
            var i, tabContent, tabButtons;
            
            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove("active");
            }
            
            tabButtons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        }
        
        let currentPlayers = [];
        
        function addPlayer() {
            if (currentPlayers.length >= 8) {
                alert('Maximum 8 players allowed!');
                return;
            }
            
            const name = document.getElementById('playerName').value;
            const playerClass = document.getElementById('playerClass').value;
            const suffix = document.getElementById('playerSuffix').value;
            
            if (!name) {
                alert('Please enter player name!');
                return;
            }
            
            currentPlayers.push({ name, class: playerClass, suffix });
            updatePlayerList();
            
            // Clear inputs
            document.getElementById('playerName').value = '';
            document.getElementById('playerSuffix').value = '';
        }
        
        function removePlayer(index) {
            currentPlayers.splice(index, 1);
            updatePlayerList();
        }
        
        function updatePlayerList() {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            
            currentPlayers.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.innerHTML = `
                    <span class="remove-player" onclick="removePlayer(${index})">×</span>
                    <div><strong>${player.name}</strong></div>
                    <div>${player.class}</div>
                    <div>${player.suffix}</div>
                `;
                playerList.appendChild(playerCard);
            });
        }
        
        function getSlotCount(nestType) {
            switch(nestType) {
                case 'Apocalypse':
                case 'Manticore':
                case 'Apocalypse Hell':
                case 'Manticore Hell':
                    return 4;
                case 'Sea Dragon Outskirt':
                case 'Sea Dragon Core':
                    return 8;
                default:
                    return 8;
            }
        }

        function updateSlotCount() {
            const nestType = document.getElementById('regNest').value;
            const slotCount = getSlotCount(nestType);
            // You can add visual feedback about the slot count if needed
        }

        // Add variable to track active tab
        let activeTabIndex = 0;

        // Modify openTeamTab function
        function openTeamTab(index) {
            activeTabIndex = index;
            // Update tab buttons
            const tabs = document.getElementsByClassName('team-tab');
            for (let tab of tabs) {
                tab.classList.remove('active');
            }
            tabs[index].classList.add('active');
            
            // Update content
            const contents = document.getElementsByClassName('team-content');
            for (let content of contents) {
                content.classList.remove('active');
            }
            contents[index].classList.add('active');
        }

        // Add function to check and remove expired raids
        async function checkAndRemoveExpiredRaids() {
            try {
                const raids = await db.getRaids();
                const now = new Date();
                const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });
                const currentTime = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });

                for (const raid of raids) {
                    // Check if raid day matches current day
                    if (raid.day === currentDay) {
                        // Parse raid time (assuming format HH:mm)
                        const [raidHour, raidMinute] = raid.time.split(':');
                        const raidTime = `${raidHour.padStart(2, '0')}:${raidMinute}`;

                        // If raid time has passed, remove the raid
                        if (raidTime <= currentTime) {
                            await db.deleteRaid(raid.id);
                            console.log(`Removed expired raid: ${raid.teamName} - ${raid.nestType}`);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking expired raids:', error);
            }
        }

        // Modify loadTeams function to check for expired raids first
        async function loadTeams() {
            try {
                // Check for expired raids before loading
                await checkAndRemoveExpiredRaids();

                const raids = await db.getRaids();
                const teamTabs = document.getElementById('teamTabs');
                const teamContents = document.getElementById('teamContents');
                
                // Store current scroll position
                const scrollPosition = window.scrollY;
                
                // Clear existing content
                teamTabs.innerHTML = '';
                teamContents.innerHTML = '';
                
                if (raids.length === 0) {
                    teamContents.innerHTML = '<p style="text-align: center; color: #e0e1dd;">No raids scheduled yet.</p>';
                    return;
                }
                
                // Create tabs and content for each team
                raids.forEach((raid, index) => {
                    // Create tab button
                    const tabButton = document.createElement('button');
                    tabButton.className = `team-tab ${index === activeTabIndex ? 'active' : ''}`;
                    tabButton.textContent = `${raid.teamName} - ${raid.nestType}`;
                    tabButton.onclick = () => openTeamTab(index);
                    teamTabs.appendChild(tabButton);
                    
                    // Create team content
                    const teamContent = document.createElement('div');
                    teamContent.className = `team-content ${index === activeTabIndex ? 'active' : ''}`;
                    
                    // Get slot count based on nest type
                    const slotCount = getSlotCount(raid.nestType);
                    
                    // Create array of players with empty slots
                    const playersWithSlots = [...raid.players];
                    while (playersWithSlots.length < slotCount) {
                        playersWithSlots.push({ name: 'EMPTY SLOT', class: '', suffix: '' });
                    }
                    
                    // Convert time to 12-hour format for display
                    let displayTime = raid.displayTime;
                    if (!displayTime) {
                        const [hours, minutes] = raid.time.split(':');
                        const hour = parseInt(hours);
                        const amPm = hour >= 12 ? 'PM' : 'AM';
                        const hour12 = hour % 12 || 12;
                        displayTime = `${hour12}:${minutes} ${amPm}`;
                    }
                    
                    teamContent.innerHTML = `
                        <div class="team-info">
                            <p><strong>Team Name:</strong> ${raid.teamName}</p>
                            <p><strong>Nest Type:</strong> ${raid.nestType}</p>
                            <p><strong>Day:</strong> ${raid.day}</p>
                            <p><strong>Time:</strong> ${displayTime}</p>
                            ${raid.description ? `<p><strong>Description:</strong> ${raid.description}</p>` : ''}
                            <p><strong>Players:</strong></p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Suffix</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${playersWithSlots.map(player => `
                                        <tr>
                                            <td class="${player.name === 'EMPTY SLOT' ? 'empty-slot' : ''}">${player.name}</td>
                                            <td>${player.class}</td>
                                            <td>${player.suffix}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    teamContents.appendChild(teamContent);
                });

                // Restore scroll position
                window.scrollTo(0, scrollPosition);
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        // Modify saveRaid function to include description
        async function saveRaid() {
            const raidName = document.getElementById('raidName').value;
            const teamName = document.getElementById('teamName').value;
            const day = document.getElementById('raidDay').value;
            const time = document.getElementById('raidTime').value;
            const nestType = document.getElementById('nestType').value;
            const description = document.getElementById('raidDescription').value;
            
            if (!teamName || !day || !time || !nestType || currentPlayers.length === 0) {
                alert('Please fill in all required fields and add at least one player!');
                return;
            }
            
            const raidData = {
                raidName,
                teamName,
                day,
                time,
                nestType,
                description,
                players: currentPlayers,
                createdDate: new Date().toISOString()
            };
            
            try {
                await db.addRaid(raidData);
                alert('Raid saved successfully!');
                
                // Reset form
                document.getElementById('teamName').value = '';
                document.getElementById('raidDay').value = '';
                document.getElementById('raidTime').value = '';
                document.getElementById('nestType').value = '';
                document.getElementById('raidDescription').value = '';
                currentPlayers = [];
                updatePlayerList();
                
                // Reload teams to show the new one
                loadTeams();
            } catch (error) {
                console.error('Error saving raid:', error);
                alert('Error saving raid. Please try again.');
            }
        }

        async function showRegistrationForm() {
            try {
                // Get all scheduled raids
                const raids = await db.getRaids();
                
                if (raids.length === 0) {
                    Swal.fire('No Raids', 'There are no raids available to register for.', 'info');
                    return;
                }

                // Filter out full raids
                const availableRaids = raids.filter(raid => {
                    const slotCount = getSlotCount(raid.nestType);
                    return !raid.players || raid.players.length < slotCount;
                });

                if (availableRaids.length === 0) {
                    Swal.fire('No Available Raids', 'All raids are currently full.', 'info');
                    return;
                }

                // Create HTML for raid selection
                const raidOptions = availableRaids.map(raid => {
                    const slotCount = getSlotCount(raid.nestType);
                    const currentPlayers = raid.players ? raid.players.length : 0;
                    const remainingSlots = slotCount - currentPlayers;
                    return `<option value="${raid.id}">${raid.teamName} - ${raid.nestType} (${raid.day}, ${raid.time}) - ${remainingSlots} slots left</option>`;
                }).join('');

                const { value: formValues } = await Swal.fire({
                    title: 'Register for Raid',
                    html: `
                        <div class="form-group">
                            <label for="selectedRaid">Select Raid:</label>
                            <select id="selectedRaid" class="swal2-input">
                                <option value="">Select a raid</option>
                                ${raidOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regIgn">In-Game Name (IGN):</label>
                            <input id="regIgn" class="swal2-input" placeholder="Enter your IGN">
                        </div>
                        <div class="form-group">
                            <label for="regClass">Class:</label>
                            <select id="regClass" class="swal2-input">
                                <option value="">Select your class</option>
                                <!-- Warrior Classes -->
                                <option value="Warrior">Warrior</option>
                                <option value="Swordsman">Swordsman</option>
                                <option value="Mercenary">Mercenary</option>
                                <!-- Archer Classes -->
                                <option value="Archer">Archer</option>
                                <option value="Bowmaster">Bowmaster</option>
                                <option value="Acrobat">Acrobat</option>
                                <!-- Sorceress Classes -->
                                <option value="Sorceress">Sorceress</option>
                                <option value="Elemental Lord">Elemental Lord</option>
                                <option value="Force User">Force User</option>
                                <!-- Cleric Classes -->
                                <option value="Cleric">Cleric</option>
                                <option value="Paladin">Paladin</option>
                                <option value="Priest">Priest</option>
                                <!-- Academic Classes -->
                                <option value="Academic">Academic</option>
                                <option value="Engineer">Engineer</option>
                                <option value="Alchemist">Alchemist</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regSuffix">Suffix:</label>
                            <input id="regSuffix" class="swal2-input" placeholder="Enter your suffix">
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Register',
                    cancelButtonText: 'Cancel',
                    preConfirm: () => {
                        const raidId = document.getElementById('selectedRaid').value;
                        const ign = document.getElementById('regIgn').value;
                        const playerClass = document.getElementById('regClass').value;
                        const suffix = document.getElementById('regSuffix').value;
                        
                        if (!raidId || !ign || !playerClass || !suffix) {
                            Swal.showValidationMessage('Please fill in all fields');
                            return false;
                        }
                        
                        return { raidId, ign, playerClass, suffix };
                    }
                });

                if (formValues) {
                    // Get the selected raid
                    const selectedRaid = raids.find(raid => raid.id === parseInt(formValues.raidId));
                    
                    if (!selectedRaid) {
                        throw new Error('Selected raid not found');
                    }

                    // Initialize players array if it doesn't exist
                    if (!selectedRaid.players) {
                        selectedRaid.players = [];
                    }

                    // Check if raid is full
                    const slotCount = getSlotCount(selectedRaid.nestType);
                    if (selectedRaid.players.length >= slotCount) {
                        throw new Error('This raid is now full');
                    }
                    
                    // Create registration data
                    const registrationData = {
                        raidId: formValues.raidId,
                        ign: formValues.ign,
                        class: formValues.playerClass,
                        suffix: formValues.suffix,
                        registrationDate: new Date().toISOString()
                    };

                    // Save registration
                    await db.addRegistration(registrationData);
                    
                    // Update the raid's players
                    selectedRaid.players.push({
                        name: formValues.ign,
                        class: formValues.playerClass,
                        suffix: formValues.suffix
                    });
                    
                    // Update the raid in the database
                    await db.updateRaid(selectedRaid);
                    
                    // Reload teams display
                    loadTeams();
                    
                    Swal.fire('Success!', 'You have been registered for the raid.', 'success');
                }
            } catch (error) {
                console.error('Error in registration:', error);
                Swal.fire('Error', error.message || 'Failed to register for the raid. Please try again.', 'error');
            }
        }

        // Set up intervals for checking expired raids and refreshing teams
        setInterval(checkAndRemoveExpiredRaids, 60000); // Check every minute
        setInterval(loadTeams, 10000); // Refresh display every 10 seconds

        async function showScheduleForm() {
            const { value: formValues } = await Swal.fire({
                title: 'Schedule a Raid',
                html: `
                    <div class="form-group">
                        <label for="teamName">Team Name:</label>
                        <input id="teamName" class="swal2-input" placeholder="Enter team name (e.g., K1, K2)">
                    </div>
                    <div class="form-group">
                        <label for="raidDate">Raid Date:</label>
                        <input type="date" id="raidDate" class="swal2-input" min="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label for="raidTime">Raid Time:</label>
                        <input type="time" id="raidTime" class="swal2-input">
                    </div>
                    <div class="form-group">
                        <label for="nestType">Nest Type:</label>
                        <select id="nestType" class="swal2-input">
                            <option value="">Select nest</option>
                            <option value="Apocalypse">Apocalypse</option>
                            <option value="Manticore">Manticore</option>
                            <option value="Apocalypse Hell">Apocalypse Hell</option>
                            <option value="Manticore Hell">Manticore Hell</option>
                            <option value="Sea Dragon Outskirt">Sea Dragon Outskirt</option>
                            <option value="Sea Dragon Core">Sea Dragon Core</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="raidDescription">Description:</label>
                        <textarea id="raidDescription" class="swal2-textarea" placeholder="Enter any additional information about the raid (e.g., requirements, notes)"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Add Player:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input id="playerName" class="swal2-input" placeholder="Player name">
                            <select id="playerClass" class="swal2-input">
                                <option value="">Select class</option>
                                <!-- Warrior Classes -->
                                <option value="Warrior">Warrior</option>
                                <option value="Swordsman">Swordsman</option>
                                <option value="Mercenary">Mercenary</option>
                                <!-- Archer Classes -->
                                <option value="Archer">Archer</option>
                                <option value="Bowmaster">Bowmaster</option>
                                <option value="Acrobat">Acrobat</option>
                                <!-- Sorceress Classes -->
                                <option value="Sorceress">Sorceress</option>
                                <option value="Elemental Lord">Elemental Lord</option>
                                <option value="Force User">Force User</option>
                                <!-- Cleric Classes -->
                                <option value="Cleric">Cleric</option>
                                <option value="Paladin">Paladin</option>
                                <option value="Priest">Priest</option>
                                <!-- Academic Classes -->
                                <option value="Academic">Academic</option>
                                <option value="Engineer">Engineer</option>
                                <option value="Alchemist">Alchemist</option>
                            </select>
                            <input id="playerSuffix" class="swal2-input" placeholder="Suffix">
                        </div>
                        <button onclick="addPlayerToSchedule()" class="btn-primary" style="width: 100%;">Add Player</button>
                    </div>
                    <div id="schedulePlayerList" class="player-list" style="margin-top: 10px;"></div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Schedule Raid',
                cancelButtonText: 'Cancel',
                focusConfirm: false,
                didOpen: () => {
                    // Initialize player list
                    currentPlayers = [];
                    updateSchedulePlayerList();
                },
                preConfirm: () => {
                    const teamName = document.getElementById('teamName').value;
                    const raidDate = document.getElementById('raidDate').value;
                    const raidTime = document.getElementById('raidTime').value;
                    const nestType = document.getElementById('nestType').value;
                    const description = document.getElementById('raidDescription').value;
                    
                    if (!teamName || !raidDate || !raidTime || !nestType || currentPlayers.length === 0) {
                        Swal.showValidationMessage('Please fill in all required fields and add at least one player');
                        return false;
                    }

                    // Convert date to day name
                    const date = new Date(raidDate);
                    const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                    
                    return {
                        teamName,
                        day,
                        date: raidDate,
                        time: raidTime,
                        displayTime: new Date(`${raidDate}T${raidTime}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                        nestType,
                        description,
                        players: [...currentPlayers]
                    };
                }
            });

            if (formValues) {
                try {
                    const raidData = {
                        raidName: 'SDN',
                        ...formValues,
                        createdDate: new Date().toISOString()
                    };
                    
                    await db.addRaid(raidData);
                    Swal.fire('Success!', 'Raid scheduled successfully!', 'success');
                    loadTeams();
                } catch (error) {
                    console.error('Error saving raid:', error);
                    Swal.fire('Error', 'Failed to schedule raid. Please try again.', 'error');
                }
            }
        }

        function addPlayerToSchedule() {
            const name = document.getElementById('playerName').value;
            const playerClass = document.getElementById('playerClass').value;
            const suffix = document.getElementById('playerSuffix').value;
            
            if (!name) {
                Swal.showValidationMessage('Please enter player name');
                return;
            }
            
            currentPlayers.push({ name, class: playerClass, suffix });
            updateSchedulePlayerList();
            
            // Clear inputs
            document.getElementById('playerName').value = '';
            document.getElementById('playerSuffix').value = '';
        }

        function updateSchedulePlayerList() {
            const playerList = document.getElementById('schedulePlayerList');
            if (!playerList) return;
            
            playerList.innerHTML = currentPlayers.map((player, index) => `
                <div class="player-card">
                    <span class="remove-player" onclick="removePlayerFromSchedule(${index})">×</span>
                    <div><strong>${player.name}</strong></div>
                    <div>${player.class}</div>
                    <div>${player.suffix}</div>
                </div>
            `).join('');
        }

        function removePlayerFromSchedule(index) {
            currentPlayers.splice(index, 1);
            updateSchedulePlayerList();
        }

        // Add delete confirmation function
        async function showDeleteConfirmation() {
            if (!isAdmin) return;

            try {
                const raids = await db.getRaids();
                if (raids.length === 0) {
                    Swal.fire('No Raids', 'There are no raids to delete.', 'info');
                    return;
                }

                const raidOptions = raids.map(raid => 
                    `<option value="${raid.id}">${raid.teamName} - ${raid.nestType} (${raid.day}, ${raid.time})</option>`
                ).join('');

                const { value: raidId } = await Swal.fire({
                    title: 'Delete Raid',
                    html: `
                        <div class="form-group">
                            <label for="raidToDelete">Select Raid to Delete:</label>
                            <select id="raidToDelete" class="swal2-input">
                                <option value="">Select a raid</option>
                                ${raidOptions}
                            </select>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Delete',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#dc3545',
                    focusConfirm: false,
                    preConfirm: () => {
                        const selectedRaid = document.getElementById('raidToDelete').value;
                        if (!selectedRaid) {
                            Swal.showValidationMessage('Please select a raid to delete');
                            return false;
                        }
                        return selectedRaid;
                    }
                });

                if (raidId) {
                    const result = await Swal.fire({
                        title: 'Are you sure?',
                        text: "This action cannot be undone!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Yes, delete it!'
                    });

                    if (result.isConfirmed) {
                        await db.deleteRaid(raidId);
                        Swal.fire('Deleted!', 'The raid has been deleted.', 'success');
                        loadTeams();
                    }
                }
            } catch (error) {
                console.error('Error in delete process:', error);
                Swal.fire('Error', 'Failed to delete raid. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>
